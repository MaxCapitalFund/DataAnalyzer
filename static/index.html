<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Trading Strategy Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .file-upload {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .file-upload.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #999;
            font-size: 0.9rem;
        }

        .analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-top: 20px;
            width: 100%;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .results-title {
            font-size: 1.8rem;
            color: #333;
        }

        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s ease;
        }

        .download-btn:hover {
            background: #218838;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-container {
            text-align: center;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            min-height: 350px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .chart-container img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .data-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }

        .data-table tr:hover {
            background: #f8f9ff;
        }

        .analytics-content {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            line-height: 1.6;
        }

        .analytics-header {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin: 15px 0 8px 0;
        }

        .analytics-subheader {
            font-size: 1.1rem;
            font-weight: bold;
            color: #555;
            margin: 12px 0 6px 0;
        }

        .analytics-paragraph {
            margin: 8px 0;
            color: #444;
        }

        .analytics-bullet {
            margin: 6px 0 6px 20px;
            color: #444;
        }

        .analytics-numbered {
            margin: 6px 0 6px 20px;
            color: #444;
        }

        .analytics-divider {
            border: none;
            height: 1px;
            background: #ddd;
            margin: 20px 0;
        }

        .analytics-content strong {
            background: #e3f2fd;
            padding: 2px 4px;
            border-radius: 3px;
            color: #1976d2;
        }

        .executive-summary {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .executive-section {
            margin-bottom: 25px;
        }

        .executive-section:last-child {
            margin-bottom: 0;
        }

        .executive-section-title {
            color: #2c3e50;
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
            position: relative;
        }

        .executive-section-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 40px;
            height: 2px;
            background: #667eea;
        }

        .executive-section-content {
            padding-left: 0;
        }

        .executive-subtitle {
            color: #34495e;
            font-size: 1.1rem;
            font-weight: 500;
            margin: 20px 0 10px 0;
        }

        .executive-paragraph {
            color: #555;
            line-height: 1.6;
            margin: 12px 0;
            font-size: 0.95rem;
        }

        .executive-bullet {
            color: #555;
            margin: 8px 0 8px 20px;
            line-height: 1.5;
            position: relative;
            font-size: 0.95rem;
        }

        .executive-bullet::before {
            content: '•';
            color: #667eea;
            font-weight: bold;
            position: absolute;
            left: -15px;
        }

        .executive-numbered {
            color: #555;
            margin: 8px 0 8px 20px;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .executive-summary strong {
            color: #2c3e50;
            font-weight: 600;
            background: none;
            padding: 0;
        }

        .executive-summary em {
            color: #7f8c8d;
            font-style: italic;
        }

        .executive-summary code {
            background: #f1f3f4;
            color: #d63384;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
        }

        .detailed-metrics {
            margin-bottom: 30px;
        }

        .horizontal-scroll-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            margin-bottom: 30px;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .horizontal-scroll-section .data-table {
            font-size: 0.8rem;
            min-width: 100%;
            width: max-content;
        }

        .horizontal-scroll-section .data-table th {
            font-size: 0.75rem;
            padding: 10px 8px;
            background: #667eea;
            color: white;
            white-space: nowrap;
        }

        .horizontal-scroll-section .data-table td {
            font-size: 0.75rem;
            padding: 8px;
            white-space: nowrap;
        }

        /* Custom scrollbar for horizontal sections */
        .horizontal-scroll-section::-webkit-scrollbar {
            height: 8px;
        }

        .horizontal-scroll-section::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 4px;
        }

        .horizontal-scroll-section::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .horizontal-scroll-section::-webkit-scrollbar-thumb:hover {
            background: #5a6fd8;
        }

        .trade-section h4, .streak-section h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 0.9rem;
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            font-size: 0.85rem;
        }

        .data-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 0.8rem;
        }

        .data-table tr:hover {
            background: #f8f9ff;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
            
            .chart-container {
                padding: 20px;
                min-height: 300px;
            }
            
            .horizontal-scroll-section {
                padding: 15px;
            }
            
            .horizontal-scroll-section .data-table {
                font-size: 0.7rem;
            }
            
            .horizontal-scroll-section .data-table th {
                font-size: 0.65rem;
                padding: 8px 6px;
            }
            
            .horizontal-scroll-section .data-table td {
                font-size: 0.65rem;
                padding: 6px;
            }
            
            .results-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .chart-container {
                padding: 15px;
                min-height: 250px;
            }
            
            .horizontal-scroll-section {
                padding: 12px;
            }
            
            .horizontal-scroll-section .data-table {
                font-size: 0.65rem;
            }
            
            .horizontal-scroll-section .data-table th {
                font-size: 0.6rem;
                padding: 6px 4px;
            }
            
            .horizontal-scroll-section .data-table td {
                font-size: 0.6rem;
                padding: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Trading Strategy Analyzer</h1>
            <p>Upload your ThinkorSwim CSV files for comprehensive backtesting analysis</p>
        </div>

        <div class="upload-section">
            <div class="file-upload" id="fileUpload">
                <div class="upload-icon">📁</div>
                <div class="upload-text">Drop your CSV file here or click to browse</div>
                <div class="upload-hint">Supports ThinkorSwim Strategy Report CSV files</div>
                <input type="file" id="fileInput" accept=".csv" />
            </div>
            <button class="analyze-btn" id="analyzeBtn" disabled>Analyze Strategy</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Analyzing your strategy... This may take a moment.</div>
        </div>

        <div class="results" id="results">
            <div class="results-header">
                <h2 class="results-title" id="resultsTitle">Analysis Results</h2>
                <button class="download-btn" id="downloadBtn">📄 Download PDF Report</button>
            </div>
            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const fileUpload = document.getElementById('fileUpload');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const resultsContent = document.getElementById('resultsContent');
        const resultsTitle = document.getElementById('resultsTitle');
        const downloadBtn = document.getElementById('downloadBtn');

        let currentResults = null;

        // File upload handling
        fileUpload.addEventListener('click', () => fileInput.click());
        fileUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUpload.classList.add('dragover');
        });
        fileUpload.addEventListener('dragleave', () => {
            fileUpload.classList.remove('dragover');
        });
        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUpload.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        });

        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect() {
            if (fileInput.files.length > 0) {
                analyzeBtn.disabled = false;
                fileUpload.querySelector('.upload-text').textContent = `Selected: ${fileInput.files[0].name}`;
            }
        }

        // Analysis
        analyzeBtn.addEventListener('click', async () => {
            if (!fileInput.files[0]) return;

            loading.style.display = 'block';
            results.style.display = 'none';
            analyzeBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('timeframe', '180d:15m');
                formData.append('capital', '2500');
                formData.append('commission', '4.04');

                // Debug: Log the URL being called
                const apiUrl = '/api/analyze';
                console.log('🔍 Calling API URL:', apiUrl);
                console.log('🔍 Current location:', window.location.href);
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Analysis failed');
                }

                currentResults = await response.json();
                displayResults(currentResults);
                results.style.display = 'block';

            } catch (error) {
                console.error('Analysis error:', error);
                resultsContent.innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                analyzeBtn.disabled = false;
            }
        });

        function parseMarkdownClean(text) {
            const lines = text.split('\n');
            let html = '';
            let currentSection = '';
            
            lines.forEach(line => {
                const trimmed = line.trim();
                
                // Skip empty lines and separators
                if (!trimmed || trimmed === '---' || trimmed === '***') {
                    return;
                }
                
                // Main headers (##)
                if (trimmed.startsWith('## ')) {
                    const title = trimmed.substring(3).replace(/\*\*/g, '');
                    html += `<div class="executive-section">
                        <h3 class="executive-section-title">${title}</h3>
                        <div class="executive-section-content">`;
                    currentSection = title;
                }
                // Sub headers (###)
                else if (trimmed.startsWith('### ')) {
                    const title = trimmed.substring(4).replace(/\*\*/g, '');
                    html += `<h4 class="executive-subtitle">${title}</h4>`;
                }
                // Bullet points
                else if (trimmed.startsWith('- ')) {
                    const content = trimmed.substring(2).replace(/\*\*/g, '<strong>').replace(/\*\*/g, '</strong>');
                    html += `<div class="executive-bullet">${content}</div>`;
                }
                // Numbered lists
                else if (trimmed.match(/^\d+\. /)) {
                    const content = trimmed.replace(/\*\*/g, '<strong>').replace(/\*\*/g, '</strong>');
                    html += `<div class="executive-numbered">${content}</div>`;
                }
                // Regular paragraphs
                else if (trimmed) {
                    // Clean up markdown formatting
                    let content = trimmed
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/`(.*?)`/g, '<code>$1</code>');
                    
                    html += `<p class="executive-paragraph">${content}</p>`;
                }
            });
            
            // Close any open section
            if (currentSection) {
                html += '</div></div>';
            }
            
            return html;
        }

        function displayResults(data) {
            resultsTitle.textContent = `${data.strategy_name} - Analysis Results`;
            
            let html = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Net Profit</div>
                        <div class="metric-value">$${data.metrics.net_profit?.toFixed(2) || 'N/A'}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Return</div>
                        <div class="metric-value">${data.metrics.total_return_pct?.toFixed(2) || 'N/A'}%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value">${data.metrics.win_rate_pct?.toFixed(2) || 'N/A'}%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Profit Factor</div>
                        <div class="metric-value">${data.metrics.profit_factor?.toFixed(2) || 'N/A'}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Max Drawdown</div>
                        <div class="metric-value">${data.metrics.max_drawdown_pct?.toFixed(2) || 'N/A'}%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Trades</div>
                        <div class="metric-value">${data.trades_rth_count || 0}</div>
                    </div>
                </div>
                
                <div class="detailed-metrics">
                    <div class="section-title">📊 Detailed Performance Metrics</div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Gross Profit</div>
                            <div class="metric-value">$${data.metrics.gross_profit?.toFixed(2) || 'N/A'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Gross Loss</div>
                            <div class="metric-value">$${data.metrics.gross_loss?.toFixed(2) || 'N/A'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Avg Win</div>
                            <div class="metric-value">$${data.metrics.avg_win_dollars?.toFixed(2) || 'N/A'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Avg Loss</div>
                            <div class="metric-value">$${data.metrics.avg_loss_dollars?.toFixed(2) || 'N/A'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Largest Win</div>
                            <div class="metric-value">$${data.metrics.largest_winning_trade?.toFixed(2) || 'N/A'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Largest Loss</div>
                            <div class="metric-value">$${data.metrics.largest_losing_trade?.toFixed(2) || 'N/A'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Expectancy</div>
                            <div class="metric-value">$${data.metrics.expectancy_per_trade_dollars?.toFixed(2) || 'N/A'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Recovery Factor</div>
                            <div class="metric-value">${data.metrics.recovery_factor?.toFixed(2) || 'N/A'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Sharpe Ratio</div>
                            <div class="metric-value">${data.metrics.sharpe_annualized?.toFixed(2) || 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `;

            // Charts
            if (data.charts) {
                html += '<div class="section-title">📈 Performance Charts</div>';
                html += '<div class="charts-grid">';
                
                if (data.charts.equity_curve) {
                    html += `
                        <div class="chart-container">
                            <div class="chart-title">Equity Curve</div>
                            <img src="${data.charts.equity_curve}" alt="Equity Curve" />
                        </div>
                    `;
                }
                
                if (data.charts.drawdown_curve) {
                    html += `
                        <div class="chart-container">
                            <div class="chart-title">Drawdown Curve</div>
                            <img src="${data.charts.drawdown_curve}" alt="Drawdown Curve" />
                        </div>
                    `;
                }
                
                if (data.charts.pl_histogram) {
                    html += `
                        <div class="chart-container">
                            <div class="chart-title">P&L Histogram</div>
                            <img src="${data.charts.pl_histogram}" alt="P&L Histogram" />
                        </div>
                    `;
                }
                
                if (data.charts.heatmap) {
                    html += `
                        <div class="chart-container">
                            <div class="chart-title">Day/Hour Heatmap</div>
                            <img src="${data.charts.heatmap}" alt="Heatmap" />
                        </div>
                    `;
                }
                
                html += '</div>';
            }


            // Data Tables
            if (data.data) {
                // Monthly Performance
                if (data.data.monthly_performance && data.data.monthly_performance.length > 0) {
                    html += '<div class="section-title">📅 Monthly Performance</div>';
                    html += createTable(data.data.monthly_performance);
                }

                // Session KPIs
                if (data.data.session_kpis && data.data.session_kpis.length > 0) {
                    html += '<div class="section-title">⏰ Session Analysis</div>';
                    html += createTable(data.data.session_kpis);
                }

                // Day of Week KPIs
                if (data.data.dow_kpis && data.data.dow_kpis.length > 0) {
                    html += '<div class="section-title">📊 Day of Week Analysis</div>';
                    html += createTable(data.data.dow_kpis);
                }

                // Hold KPIs
                if (data.data.hold_kpis && data.data.hold_kpis.length > 0) {
                    html += '<div class="section-title">⏱️ Hold Time Analysis</div>';
                    html += createTable(data.data.hold_kpis);
                }

                // Trade & Streak Analysis - 4 Separate Sections with Horizontal Scroll
                if (data.data.top_best_trades && data.data.top_best_trades.length > 0) {
                    html += '<div class="section-title">🏆 Best Trades</div>';
                    html += '<div class="horizontal-scroll-section">';
                    html += createTable(data.data.top_best_trades);
                    html += '</div>';
                }
                
                if (data.data.top_worst_trades && data.data.top_worst_trades.length > 0) {
                    html += '<div class="section-title">📉 Worst Trades</div>';
                    html += '<div class="horizontal-scroll-section">';
                    html += createTable(data.data.top_worst_trades);
                    html += '</div>';
                }
                
                if (data.data.max_win_streak && data.data.max_win_streak.length > 0) {
                    html += '<div class="section-title">🔥 Max Win Streak</div>';
                    html += '<div class="horizontal-scroll-section">';
                    html += createTable(data.data.max_win_streak);
                    html += '</div>';
                }
                
                if (data.data.max_loss_streak && data.data.max_loss_streak.length > 0) {
                    html += '<div class="section-title">❄️ Max Loss Streak</div>';
                    html += '<div class="horizontal-scroll-section">';
                    html += createTable(data.data.max_loss_streak);
                    html += '</div>';
                }
            }

            // Executive Summary - At the bottom with enhanced styling
            if (data.analytics_md) {
                html += '<div class="section-title">📋 Executive Summary</div>';
                html += '<div class="executive-summary">';
                html += parseMarkdownClean(data.analytics_md);
                html += '</div>';
            }

            resultsContent.innerHTML = html;
        }

        function createTable(data) {
            if (!data || data.length === 0) return '<p>No data available</p>';
            
            const headers = Object.keys(data[0]);
            let html = '<table class="data-table"><thead><tr>';
            
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            
            html += '</tr></thead><tbody>';
            
            data.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    const value = row[header] || '';
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }

        function parseMarkdown(text) {
            const lines = text.split('\n');
            let html = '';
            
            lines.forEach(line => {
                const trimmed = line.trim();
                
                if (trimmed.startsWith('## ')) {
                    html += `<div class="analytics-header">${trimmed.substring(3)}</div>`;
                } else if (trimmed.startsWith('### ')) {
                    html += `<div class="analytics-subheader">${trimmed.substring(4)}</div>`;
                } else if (trimmed.startsWith('- ')) {
                    html += `<div class="analytics-bullet">• ${trimmed.substring(2)}</div>`;
                } else if (trimmed.match(/^\d+\. /)) {
                    html += `<div class="analytics-numbered">${trimmed}</div>`;
                } else if (trimmed === '---') {
                    html += '<hr class="analytics-divider">';
                } else if (trimmed) {
                    html += `<div class="analytics-paragraph">${trimmed}</div>`;
                }
            });
            
            return html;
        }

        // PDF Download
        downloadBtn.addEventListener('click', async () => {
            if (!currentResults) return;
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            let pageCount = 1;
            
            // Helper function to check page breaks
            function checkPageBreak(requiredSpace = 20) {
                if (pdf.internal.pageSize.height - yPos < requiredSpace) {
                    pdf.addPage();
                    pageCount++;
                    yPos = 20;
                    return true;
                }
                return false;
            }
            
            // Helper function to add data table
            function addDataTable(title, data, headers) {
                checkPageBreak(50);
                
                pdf.setFontSize(14);
                pdf.text(title, 20, yPos);
                yPos += 15;
                
                if (!data || data.length === 0) {
                    pdf.setFontSize(10);
                    pdf.text('No data available', 20, yPos);
                    yPos += 10;
                    return;
                }
                
                const colWidth = 170 / headers.length;
                const startX = 20;
                
                // Headers
                pdf.setFontSize(8);
                pdf.setFillColor(102, 126, 234);
                pdf.rect(startX, yPos - 5, 170, 8, 'F');
                pdf.setTextColor(255, 255, 255);
                
                headers.forEach((header, index) => {
                    const x = startX + (index * colWidth);
                    pdf.text(header.substring(0, 15), x + 2, yPos);
                });
                
                yPos += 10;
                pdf.setTextColor(0, 0, 0);
                
                // Data rows
                data.slice(0, 15).forEach((row, rowIndex) => {
                    checkPageBreak(15);
                    
                    headers.forEach((header, colIndex) => {
                        const x = startX + (colIndex * colWidth);
                        const value = String(row[header] || '').substring(0, 12);
                        pdf.text(value, x + 2, yPos);
                    });
                    yPos += 6;
                });
                
                if (data.length > 15) {
                    pdf.setFontSize(8);
                    pdf.text(`Showing 15 of ${data.length} rows`, 20, yPos);
                    yPos += 8;
                }
                
                yPos += 10;
            }
            
            // Helper function to add chart
            function addChart(chartTitle, chartData) {
                if (!chartData) return;
                
                checkPageBreak(80);
                pdf.setFontSize(14);
                pdf.text(chartTitle, 20, yPos);
                yPos += 15;
                
                try {
                    const imgWidth = 170;
                    const imgHeight = 110;
                    const x = (pdf.internal.pageSize.width - imgWidth) / 2;
                    pdf.addImage(chartData, 'PNG', x, yPos, imgWidth, imgHeight);
                    yPos += imgHeight + 15;
                } catch (error) {
                    console.error(`Error adding ${chartTitle}:`, error);
                    pdf.setFontSize(10);
                    pdf.text(`Error loading ${chartTitle}`, 20, yPos);
                    yPos += 10;
                }
            }
            
            // Page 1: Title and Key Metrics
            pdf.setFontSize(20);
            pdf.text(currentResults.strategy_name || 'Trading Strategy Analysis', 20, 30);
            
            pdf.setFontSize(12);
            let yPos = 50;
            
            // Key metrics
            const keyMetrics = [
                `Net Profit: $${currentResults.metrics.net_profit?.toFixed(2) || 'N/A'}`,
                `Total Return: ${currentResults.metrics.total_return_pct?.toFixed(2) || 'N/A'}%`,
                `Win Rate: ${currentResults.metrics.win_rate_pct?.toFixed(2) || 'N/A'}%`,
                `Profit Factor: ${currentResults.metrics.profit_factor?.toFixed(2) || 'N/A'}`,
                `Max Drawdown: ${currentResults.metrics.max_drawdown_pct?.toFixed(2) || 'N/A'}%`,
                `Total Trades: ${currentResults.trades_rth_count || 0}`,
                `Gross Profit: $${currentResults.metrics.gross_profit?.toFixed(2) || 'N/A'}`,
                `Gross Loss: $${currentResults.metrics.gross_loss?.toFixed(2) || 'N/A'}`,
                `Avg Win: $${currentResults.metrics.avg_win_dollars?.toFixed(2) || 'N/A'}`,
                `Avg Loss: $${currentResults.metrics.avg_loss_dollars?.toFixed(2) || 'N/A'}`,
                `Largest Win: $${currentResults.metrics.largest_winning_trade?.toFixed(2) || 'N/A'}`,
                `Largest Loss: $${currentResults.metrics.largest_losing_trade?.toFixed(2) || 'N/A'}`,
                `Expectancy: $${currentResults.metrics.expectancy_per_trade_dollars?.toFixed(2) || 'N/A'}`,
                `Recovery Factor: ${currentResults.metrics.recovery_factor?.toFixed(2) || 'N/A'}`,
                `Sharpe Ratio: ${currentResults.metrics.sharpe_annualized?.toFixed(2) || 'N/A'}`
            ];
            
            keyMetrics.forEach(metric => {
                pdf.text(metric, 20, yPos);
                yPos += 8;
            });
            
            // Add charts if available
            if (currentResults.charts) {
                yPos += 20;
                pdf.setFontSize(16);
                pdf.text('Performance Charts', 20, yPos);
                yPos += 15;
                
                // Add each chart
                if (currentResults.charts.equity_curve) {
                    addChart('Equity Curve', currentResults.charts.equity_curve);
                }
                
                if (currentResults.charts.drawdown_curve) {
                    addChart('Drawdown Curve', currentResults.charts.drawdown_curve);
                }
                
                if (currentResults.charts.pl_histogram) {
                    addChart('P&L Histogram', currentResults.charts.pl_histogram);
                }
                
                if (currentResults.charts.heatmap) {
                    addChart('Performance Heatmap', currentResults.charts.heatmap);
                }
            }
            
            // Add data tables
            if (currentResults.data) {
                if (currentResults.data.monthly_performance?.length > 0) {
                    const headers = Object.keys(currentResults.data.monthly_performance[0]);
                    addDataTable('Monthly Performance', currentResults.data.monthly_performance, headers);
                }
                
                if (currentResults.data.session_kpis?.length > 0) {
                    const headers = Object.keys(currentResults.data.session_kpis[0]);
                    addDataTable('Session Analysis', currentResults.data.session_kpis, headers);
                }
                
                if (currentResults.data.dow_kpis?.length > 0) {
                    const headers = Object.keys(currentResults.data.dow_kpis[0]);
                    addDataTable('Day of Week Analysis', currentResults.data.dow_kpis, headers);
                }
                
                if (currentResults.data.hold_kpis?.length > 0) {
                    const headers = Object.keys(currentResults.data.hold_kpis[0]);
                    addDataTable('Hold Time Analysis', currentResults.data.hold_kpis, headers);
                }
                
                if (currentResults.data.top_best_trades?.length > 0) {
                    const headers = Object.keys(currentResults.data.top_best_trades[0]);
                    addDataTable('Best Trades', currentResults.data.top_best_trades, headers);
                }
                
                if (currentResults.data.top_worst_trades?.length > 0) {
                    const headers = Object.keys(currentResults.data.top_worst_trades[0]);
                    addDataTable('Worst Trades', currentResults.data.top_worst_trades, headers);
                }
                
                if (currentResults.data.max_win_streak?.length > 0) {
                    const headers = Object.keys(currentResults.data.max_win_streak[0]);
                    addDataTable('Max Win Streak', currentResults.data.max_win_streak, headers);
                }
                
                if (currentResults.data.max_loss_streak?.length > 0) {
                    const headers = Object.keys(currentResults.data.max_loss_streak[0]);
                    addDataTable('Max Loss Streak', currentResults.data.max_loss_streak, headers);
                }
            }
            
            // Add analytics summary
            if (currentResults.analytics_md) {
                checkPageBreak(30);
                pdf.setFontSize(14);
                pdf.text('Executive Summary', 20, yPos);
                yPos += 15;
                
                pdf.setFontSize(9);
                const analyticsLines = currentResults.analytics_md.split('\n');
                analyticsLines.forEach(line => {
                    if (line.trim()) {
                        checkPageBreak(8);
                        const cleanLine = line.replace(/^#+\s*/, '').replace(/^\*\*/, '').replace(/\*\*$/, '').replace(/^-\s*/, '• ');
                        pdf.text(cleanLine.substring(0, 80), 20, yPos);
                        yPos += 6;
                    }
                });
            }
            
            // Save PDF
            pdf.save(`${currentResults.strategy_name || 'strategy'}_analysis.pdf`);
        });
    </script>
</body>
</html>
